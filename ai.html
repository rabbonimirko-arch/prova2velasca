<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Avatar AI · Face Detection PRO (Debug)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{margin:0;padding:0;height:100%;width:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{display:flex;flex-direction:column;overflow:hidden}
    header{padding:10px 14px;font-size:.8rem;letter-spacing:.12em;text-transform:uppercase;color:#ddd;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.08);z-index:1000}
    .app{position:relative;flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .frame{position:relative;width:100vw;max-width:540px;aspect-ratio:9/16;overflow:hidden;background:#000}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;padding:18px;background:radial-gradient(ellipse at center, rgba(0,0,0,.45), rgba(0,0,0,.90));z-index:5}
    .overlay.hidden{display:none}
    .card{max-width:360px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:14px 14px;backdrop-filter:blur(10px)}
    .title{font-size:.95rem;font-weight:650;margin-bottom:6px}
    .sub{font-size:.8rem;opacity:.9;line-height:1.35}

    #heygen-streaming-embed{position:absolute!important;inset:0!important;width:100%!important;height:100%!important;border:none!important;opacity:0;visibility:hidden;z-index:10;transition:opacity .25s ease-out}
    #heygen-streaming-embed.show{opacity:1;visibility:visible}
    #heygen-streaming-container,#heygen-streaming-container iframe{width:100%!important;height:100%!important;border:0!important}

    /* cam invisibile ma in debug la facciamo vedere piccola */
    #camVideo{
      position:absolute;
      right:10px; bottom:10px;
      width:120px; height:160px;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.25);
      border-radius:12px;
      z-index:30;
      opacity:.9;
    }

    #hud{
      position:absolute;top:10px;left:10px;z-index:40;font-size:12px;color:#fff;
      background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:12px;white-space:pre-line
    }
  </style>
</head>

<body>
  <header>
    <div>Avatar AI</div>
    <div>Face Detection PRO · DEBUG</div>
  </header>

  <div class="app">
    <div class="frame" id="frame">
      <div id="hud">Boot…</div>

      <div class="overlay" id="ovIdle">
        <div class="card">
          <div class="title">Avvicinati per attivare l’assistente</div>
          <div class="sub">Debug attivo: controlla HUD e la mini-preview camera.</div>
        </div>
      </div>

      <div class="overlay hidden" id="ovPerm">
        <div class="card">
          <div class="title">Consenti la videocamera</div>
          <div class="sub">Serve per rilevare il volto. Abilita i permessi nel browser.</div>
        </div>
      </div>

      <div class="overlay hidden" id="ovErr">
        <div class="card">
          <div class="title">Errore</div>
          <div class="sub" id="ovErrMsg">—</div>
        </div>
      </div>
    </div>
  </div>

  <video id="camVideo" autoplay muted playsinline></video>

  <!-- MediaPipe locali -->
  <script src="./camera_utils.js"></script>
  <script src="./face_detection.js"></script>

  <script>
    // ===== CONFIG =====
    const CONFIG = {
      presenceOnMs: 450,
      presenceOffMs: 1200,
      minOnDurationMs: 4000,
      minOffDurationMs: 1500,
      detectionConfidence: 0.55, // abbassata per farlo partire facilmente
      selfieMode: true,
      locateAssets: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
    };

    // ===== HEYGEN URL =====
    const HEYGEN_HOST = "https://labs.heygen.com";
    const HEYGEN_URL =
      HEYGEN_HOST +
      "/guest/streaming-embed?share=eyJxdWFsaXR5IjoiaGlnaCIsImF2YXRhck5hbWUiOiJLYXR5YV9Qcm9mZXNzaW9uYWxMb29rX3B1%0D%0AYmxpYyIsInByZXZpZXdJbWciOiJodHRwczovL2ZpbGVzMi5oZXlnZW4uYWkvYXZhdGFyL3YzLzM0%0D%0AOGRkZjUwM2M2NTRiOWJiYmI4YmVhOWY5MjEwZWFkXzU1ODcwL3ByZXZpZXdfdGFyZ2V0LndlYnAi%0D%0ALCJuZWVkUmVtb3ZlQmFja2dyb3VuZCI6dHJ1ZSwia25vd2xlZGdlQmFzZUlkIjoiY2E3M2VmNmY2%0D%0AOTdhNGFhMTgzZGM1MzZkY2EyMDY3YmYiLCJ1c2VybmFtZSI6ImZiNDBjZGI1NjdlZjRjMTg5MDM4%0D%0ANDkwODI5YzIwZTZmIn0%3D&inIFrame=1";

    // ===== UI refs =====
    const frame = document.getElementById("frame");
    const hud = document.getElementById("hud");
    const ovIdle = document.getElementById("ovIdle");
    const ovPerm = document.getElementById("ovPerm");
    const ovErr = document.getElementById("ovErr");
    const ovErrMsg = document.getElementById("ovErrMsg");
    const camVideo = document.getElementById("camVideo");

    function setHud(text){ hud.textContent = text; }

    // ===== Build HeyGen wrapper =====
    const heygenWrap = document.createElement("div");
    heygenWrap.id = "heygen-streaming-embed";
    const heygenContainer = document.createElement("div");
    heygenContainer.id = "heygen-streaming-container";
    const heygenIframe = document.createElement("iframe");
    heygenIframe.allowFullscreen = false;
    heygenIframe.title = "Avatar AI";
    heygenIframe.role = "
